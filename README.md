# КОД

Контролируемый обмен данными - это механизм построения многоузловой базы из нескольких информационных баз на платформе "1С:Предприятие" с быстрой репликацией всех изменений или их части с поддержкой ссылочной целостности. Главные отличия от РИБ:

* Конфигурации узлов не обязаны совпадать
* Вместо таблиц регистрации изменений используются отметки времени
* Нет квитирования (КОД полагается на гарантированную доставку изменений)
* Изменения передаются не одним большим сообщением, а множеством маленьких, что удобно для обмена через шины вроде Kafka или RabbitMQ
* Есть встроенный механизм контроля ссылочной целостности
* Используется не XML, а JSON

## Архитектура

Многоузловая база состоит из центрального узла и подчиненных узлов. Сведения о них хранятся в иерархическом справочнике **УзлыКОД** с предопределенным элементом **ЭтотУзел**.

Данные, участвующие в обмене, включены в подсистему КОД и подписки подсистемы ОтметкиВремени и при записи получают отметки времени, хранящиеся в специализированных регистрах. Отметки используются как для определения изменений, подлежащих отправке, так и для контроля коллизий.

Регулярная отправка и получение данных выполняются регламентными заданиями "Диспетчер отправки КОД" и "Диспетчер получения КОД", работающими независимо. Код разделен на общие модули КОДПолучение и КОДОтправка, с общими процедурами и функциями в модулях КОДСервер и КОДСлужебный.

### Отметки времени

Отметка времени - это строка, хранящая универсальную дату в миллисекундах в формате "YYYYMMDDHHmmssuuu".
Отметки времени ссылочных данных хранятся в разрезе ссылок. Удаление объекта - это наличие отметки без самого объекта по ссылке.
Отметки времени наборов записей регистров хранятся в разрезе ключей. Ключ - это строка JSON, содержащая значения основных отборов набора записей. Внутри это массив JSON из пар "свойство - значение", где имя свойства определяет тип значения измерения, а значение представляет само значение:

[{"dateTime":"2020-07-27T16:03:05"},{"390c64d9-1ef8-11e9-8a62-0050569f6126":"714c9c28-cffd-11ea-80e7-0050569f6c88"},{"390c648a-1ef8-11e9-8a62-0050569f6126":"aa00559e-ad84-4494-88fd-f0826edc46f0"}]

Примитивные типы описываются именами соответствующих им типов в XML ("string", "dateTime", ...), ссылочные - УИДами идентификаторов объектов метаданных, поэтому ключ одного и того же набора в разных узлах будет отличаться. Значения перечислений сериализуются как их идентификаторы, хранящиеся в РС **ИдентификаторыЗначенийПеречислений**.

КОД - не единтвенный потребитель подсистемы ОтметкиВремени.

### Структура сообщения

Сообщение - это файл JSON вида:

<Отправитель>to<Адресат>at<Отметка времени>-<Номер сообщения>.json

* Отправитель - код узла-отправителя
* Получатель - код узла-адресата
* Отметка времени - отметка времени начала сеанса отправки
* Номер сообщения - номер сообщения в сеансе отправки

Сообщение содержит единственный объект message со свойствами header и body.
Заголовок (header) содержит коды отправителя и получателя и версию обмена (сейчас всегда 1).
Тело (body) содержит массив объектов object со свойствами #ns (пространство имен, для текущей версии "http://v8.1c.ru/doc8/CDE/1"), #type (тип формата "Справочник.Контрагенты") и #value (собственно данные, чья структура определяется XDTO-пакетом).

Отправитель объединяет в одно сообщение данные, связанные ссылками, а получатель записывает каждое сообщение в своей транзакции, чтобы обеспечить ссылочную целостность.
Сообщения с одной отметкой времени, но с разными номерами, принимаются параллельно. Сообщения с последовательными отметками принимаются последовательно.

### XDTO-пакет

XDTO-пакет КОД_1 содержит описание всех данных, участвующих в обмене. Сериализация и десериализация выполняются полностью автоматически, если:

* Существует объект XDTO с полным именем объекта метаданных ("Справочник.Контрагенты", "РегистрСведений.ТекущиеСостоянияДокументов").
* Его структура и свойства совпадают со структурой и свойствами объекта метаданных: например, реквизитам соответствуют одноименные свойства объекта, табличным частям - одноименные списки и т.д. Объекты XDTO для наборов записей регистров должны содержать:
  * Свойство Отбор с подчиненными свойствами для значений измерений из основного отбора;
  * Список Записи с ресурсами, реквизитами и измерениями вне основного отбора.
  
Примитивные типы передаются типами из пространства XML ("decimal", "string", "dateTime", "boolean").
Для ссылок в XDTO-пакете КОД_1 предусмотрен тип Ссылка.
Для составных типов, которые могут содержать значение Неопределено, следует установить флаг "Возможно пустое".
Для составных типов, содержащих и ссылочные, и примитивные типы, используется тип XML anyType.

Менеджеры объектов могут переопределить сериализацию и десериализацию (ПриЗаписиВСообщениеКОД, ПриЧтенииИзСообщенияКОД), например, чтобы включить в состав объекта данные, хранящиеся вне его (например, так передаются пароли учетных записей почты и реквизиты писем), или не передавать часть данных (например, в составе справочника Пользователи не передается идентификатор пользователя ИБ). В этом случае объект XDTO может не соответствовать метаданным.

Встроенный контроль (КОДСервер.ПроверитьСоответствиеМетаданныхПакетуОбмена) выполняется при каждом обновлении ИБ. Исключения описываются переопределением обработчика ПриОпределенииИсключенийКОД модуля менеджера.

Обработка ОписаниеМетаданныхДляКОД автоматически создает XSD-схему по метаданным, которую можно загрузить в пакет обмена, но не учитывает переопределение в менеджерах.

### Регулярная отправка

Цикл регулярной отправки состоит из выборки изменений, их рассмотрения с определением адресатов и отправки с предварительным делением на потоки. Выборка изменений с рассмотрением начинаются, не дожидаясь завершения отправки: таким образом, когда сеанс отправки завершится, для следующего сеанса уже будет готова порция выбранных и рассмотренных изменений.

Регламентное задание "Диспетчер отправки КОД":
1. Выбирает порцию данных, непрерывную по отметкам, от текущей границы рассмотрения изменений;
2. Рассматривает их, определяя узлы-адресаты для каждого измененного элемента данных;
3. Делит рассмотренные изменения на потоки отправки;
4. Запускает фоновые задания отправки, формирующие сообщения с общей отметкой начала сеанса отправки, но разными номерами;
5. Записывает сведения об отправке и рассмотрении и сдвигает границу рассмотрения изменений.

#### Выборка изменений

Текущая граница рассмотрения (отметка) хранится в константе **ГраницаРассмотренияКОД**. Выброрка изменений выбирает ограниченную порцию изменений (захардкодено) так, чтобы выбранные изменения ссылочных данных и наборов записей не превышали по объему эту порцию и были непрерывны от текущей границы. Изменения, которые будут зафиксированы длящимися в этот момент транзакциями, выбирают и отправляют отдельные задания "Отправка пропущенных изменений КОД".

#### Рассмотрение изменений

Рассмотрение распределяет каждый элемент выбранных изменений по узлам-адресатам, куда эти данные следует отправить. Правила рассмотрения:

1. Данные из подчиненного узла, участвующие в обмене, полностью отправляются в центральный узел.
2. НСИ (точнее, данные, включенные в подсистему КОД.НСИ) полностью отправляется во все узлы.
3. Данные, не относящиеся к НСИ, делятся на зависимые и самостоятельные переопределением процедуры модуля менеджера ПриОпределенииПоляВладельцаДанных (данные без владельца - самостоятельные). После чего:
  3.1. Самостоятельные данные (например, документы) отправляются в узлы пользователей, имеющих права на них.
  3.2. Зависимые данные (например, файлы документов) отправляются в узлы вместе с самостоятельными данными.
4. Данные, однажды отправлявшиеся в узел, будут отправляться в него повторно, даже если текущее состояние прав доступа этого не требует, чтобы в узлах не накапливались неактуальные версии данных.

#### Деление на потоки

Паралеллизмом отправки управляет константа **МаксимальноеЧислоПотоковОтправкиКОД**. Ее значение определяет максимальное число фоновых заданий отправки, которые будут запущены после рассмотрения. При установке в 0 отправка прекращается. Правила деления на потоки:

1. В потоке не может быть данных меньше, чем МинимумОбъектовДляФоновогоЗадания().
2. Зависимые данные, относящиеся к одному элементу самостоятельных данных (например, файлы документа), и эти самостоятельные данные попадают в один поток.
3. Потоков не может быть больше, чем **МаксимальноеЧислоПотоковОтправкиКОД**.

#### Отправка изменений

Поток отправки изменений:
1. Сериализует доставшуюся ему порцию изменений с помощью фабрики XDTO.
2. Добавляет к ним данные, которые по ссылкам также требуется отправить в узлы-адресаты.
3. Формирует сообщения так, чтобы данные, объединенные ссылками друг на друга, оказались в одном сообщении.
4. Записывает сообщения, возвращая диспетчеру отправки сведения о состоявшейся отправке.

#### Контроль ссылочной целостности



#### Запись сведений об отправке и рассмотрении

### Отправка исторических данных

### Отправка пропущенных изменений

### Получение сообщений

Регламентное задание "Диспетчер получения КОД":
1. Выбирает порцию сообщений к получению;
2. Делит их на потоки, допускающие параллельное получение;
3. Запускает фоновые задания получения и дожидается их завершения.

## Учет изменений в метаданных

### Добавление новых объектов

### Изменение существующих объектов

#### Типы данных КОД

## Решение проблем

## Открытые вопросы

### Производительность

### Автогенерация пакета XDTO

### Версионирование

Единственный механизм, который КОД сейчас предоставляет для обмена данными с разными версиями метаданных - это совместимость на уровне XDTO-пакета. Например, для новых реквизитов можно поставить "Минимальное количество = 0", и новые версии конфигурации примут сообщения старых версий. Переименование реквизитов также можно поддержать созданием нового реквизита со свойством "Минимальное количество = 0". Пакет также можно подменить в режиме Предприятия, загрузив в константу выгруженную XSD-схему (это несколько замедлит обмен, поскольку каждый сеанс КОД будет создавать фабрику XDTO из тяжелого макета).

Есть, однако, проблемы с более тяжелыми изменениями метаданных, например:
* Новые объекты метаданных. Что узел старой конфигурации должен делать с новыми объектами?
* Изменение структуры регистра сведений. Как быть с накопленными отметками? Что узел-получатель должен делать с наборами записей иной структуры?

Следует решить, в каком объеме КОД будет поддерживать версионирование: только ли на краткий период обновления всех узлов? Или режим с разными версиями ИБ узлов будет рабочим? Какого рода изменения метаданных мы будем поддерживать, а какие - нет?

### Режим восстановления

КОД первого поколения для конфигурации "Документооборот Почты России" включал в себя механизм восстановления узлов данными других узлов при потере. При разработке второго поколения механизм восстановления не тестировался и, скорее всего, сломан. Для типовой следует принять решение либо о вырезании механизма восстановления, либо о его восстановлении.
