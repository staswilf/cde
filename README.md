# КОД

Контролируемый обмен данными - это механизм построения многоузловой базы из нескольких информационных баз на платформе "1С:Предприятие" с быстрой репликацией всех изменений или их части с поддержкой ссылочной целостности. Главные отличия от РИБ:

* Конфигурации узлов не обязаны совпадать
* Вместо таблиц регистрации изменений используются отметки времени
* Нет квитирования (КОД полагается на гарантированную доставку изменений)
* Изменения передаются не одним большим сообщением, а множеством маленьких, что удобно для обмена через шины вроде Kafka или RabbitMQ
* Есть встроенный механизм контроля ссылочной целостности
* Используется не XML, а JSON

## Архитектура

Многоузловая база состоит из центрального узла и подчиненных узлов. Данные, участвующие в обмене, включены в подсистему КОД и при записи получают отметки времени, хранящиеся в специализированных регистрах. 

Регламентное задание "Диспетчер отправки КОД":
1. Выбирает порцию данных, непрерывную по отметкам, от текущей границы рассмотрения изменений;
2. Рассматривает их, определяя узлы-адресаты для каждого измененного элемента данных;
3. Делит рассмотренные изменения на потоки отправки;
4. Запускает фоновые задания отправки, формирующие сообщения;
5. Записывает сведения об отправке и рассмотрении и сдвигает границу рассмотрения изменений.

Регламентное задание "Диспетчер получения КОД":
1. Выбирает порцию сообщений к получению;
2. Делит их на потоки, допускающие параллельное получение;
3. Запускает фоновые задания получения и дожидается их завершения.

### Отметки времени

Отметка времени - это строка, хранящая универсальную дату в миллисекундах в формате "YYYYMMDDHHmmssuuu".
Отметки времени ссылочных данных хранятся в разрезе ссылок. Удаление объекта - это наличие отметки без самого объекта по ссылке.
Отметки времени наборов записей регистров хранятся в разрезе ключей. Ключ - это строка JSON, содержащая значения основных отборов набора записей. Внутри это массив JSON из пар, где имя свойства определяет тип значения измерения, а значение содержит само значение:

[{"dateTime":"2020-07-27T16:03:05"},{"390c64d9-1ef8-11e9-8a62-0050569f6126":"714c9c28-cffd-11ea-80e7-0050569f6c88"},{"390c648a-1ef8-11e9-8a62-0050569f6126":"aa00559e-ad84-4494-88fd-f0826edc46f0"}]

Примитивные типы описываются именами их соответствий в XML, ссылочные - УИДами идентификаторов объектов метаданных, поэтому ключ одного и того же набора в разных узлах будет отличаться.

### Структура сообщения

Сообщение - это файл JSON вида:

<Отправитель>to<Адресат>at<Отметка времени>-<Номер сообщения>.json

* Отправитель - код узла-отправителя
* Получатель - код узла-адресата
* Отметка времени - отметка времени начала сеанса отправки
* Номер сообщения - номер сообщения в сеансе отправки

Сообщение содержит единственный объект message со свойствами header и body.
Заголовок (header) содержит коды отправителя и получателя и версию обмена (сейчас всегда 1).
Тело (body) содержит массив объектов object со свойствами #ns (пространство имен, для текущей версии "http://v8.1c.ru/doc8/CDE/1"), #type (тип формата "Справочник.Контрагенты") и #value (собственно данные, чья структура определяется XDTO-пакетом).

Отправитель объединяет в одно сообщение данные, связанные ссылками, а получатель записывает каждое сообщение в своей транзакции, чтобы обеспечить ссылочную целостность.
Сообщения с одной отметкой времени, но с разными номерами, принимаются параллельно. Сообщения с последовательными отметками принимаются последовательно.

### Регулярная отправка

Цикл регулярной отправки состоит из выборки изменений, их рассмотрения с определением адресатов и отправки с предварительным делением на потоки. Выборка изменений с рассмотрением начинаются, не дожидаясь завершения отправки. Таким образом, когда сеанс отправки завершится, для следующего сеанса уже будет готова порция рассмотренных изменений.

#### Выборка изменений

Текущая граница рассмотрения (отметка) хранится в константе **ГраницаРассмотренияКОД**. Выброрка изменений выбирает ограниченную порцию изменений (сейчас захардкодено 1000) так, чтобы выбранные изменения ссылочных данных и наборов записей не превышали по объему эту порцию и были непрерывны от текущей границы. Изменения, которые будут зафиксированы длящимися в этот момент транзакции, выбирает отдельные задания "Отправка пропущенных изменений КОД".

#### Рассмотрение изменений

Рассмотрение распределяет каждый элемент выбранных изменений по узлам-адресатам, куда эти данные следует отправить. Правила рассмотрения:

1. Данные из подчиненного узла, участвующие в обмене, полностью отправляются в центральный узел.
2. НСИ (точнее, данные, включенные в подсистему КОД.НСИ) полностью отправляется во все узлы.
3. Данные, не относящиеся к НСИ, делятся на зависимые и самостоятельные переопределением процедуры модуля менеджера ПриОпределенииПоляВладельцаДанных. После чего:
  3.1. Самостоятельные данные (например, документы) отправляются в узлы пользователей, имеющих права на них.
  3.2. Зависимые данные (например, файлы документов) отправляются в узлы вместе с самостоятельными данными.
4. Данные, однажды отправлявшиеся в узел, будут отправляться в него повторно, даже если текущее состояние прав доступа этого не требует, чтобы в узлах не накапливались неактуальные версии данных.

#### Деление на потоки

Паралеллизмом отправки управляет константа **МаксимальноеЧислоПотоковОтправкиКОД**. Ее значение определяет максимальное число фоновых заданий отправки, которые будут запущены после рассмотрения. При установке в 0 отправка прекращается.

#### Отправка изменений

#### Контроль ссылочной целостности

#### Запись сведений об отправке и рассмотрении

### Отправка исторических данных

### Отправка пропущенных изменений

### Получение сообщений

## Учет изменений в метаданных

### Добавление новых объектов

### Изменение существующих объектов

#### Типы данных КОД

## Решение проблем

## Открытые вопросы

### Производительность

### Автогенерация пакета XDTO

### Версионирование

Единственный механизм, который КОД сейчас предоставляет для обмена данными с разными версиями метаданных - это совместимость на уровне XDTO-пакета. Например, для новых реквизитов можно поставить "Минимальное количество = 0", и новые версии конфигурации примут сообщения старых версий. Переименование реквизитов также можно поддержать созданием нового реквизита со свойством "Минимальное количество = 0". Пакет также можно подменить в режиме Предприятия, загрузив в константу выгруженную XSD-схему (это несколько замедлит обмен, поскольку каждый сеанс КОД будет создавать фабрику XDTO из тяжелого макета).

Есть, однако, проблемы с более тяжелыми изменениями метаданных, например:
* Новые объекты метаданных. Что узел старой конфигурации должен делать с новыми объектами?
* Изменение структуры регистра сведений. Как быть с накопленными отметками? Что узел-получатель должен делать с наборами записей иной структуры?

Следует решить, в каком объеме КОД будет поддерживать версионирование: только ли на краткий период обновления всех узлов? Или режим с разными версиями ИБ узлов будет рабочим? Какого рода изменения метаданных мы будем поддерживать, а какие - нет?

### Режим восстановления

КОД первого поколения для конфигурации "Документооборот Почты России" включал в себя механизм восстановления узлов данными других узлов при потере. При разработке второго поколения механизм восстановления не тестировался и, скорее всего, сломан. Для типовой следует принять решение либо о вырезании механизма восстановления, либо о его восстановлении.
