# КОД

Контролируемый обмен данными - это механизм построения многоузловой базы из нескольких информационных баз на платформе "1С:Предприятие" с быстрой репликацией всех изменений или их части с поддержкой ссылочной целостности. Главные отличия от РИБ:

* Конфигурации узлов не обязаны совпадать
* Вместо таблиц регистрации изменений используются отметки времени
* Нет квитирования (КОД полагается на гарантированную доставку изменений)
* Изменения передаются не одним большим сообщением, а множеством маленьких, что удобно для обмена через шины вроде Kafka или RabbitMQ
* Есть встроенный механизм контроля ссылочной целостности
* Используется не XML, а JSON

## Архитектура

### Структура сообщения

### Отметки времени

### Регулярная отправка

#### Выборка изменений

#### Рассмотрение изменений

#### Деление на потоки

#### Отправка изменений

#### Контроль ссылочной целостности

#### Запись сведений об отправке и рассмотрении

### Отправка исторических данных

### Получение сообщений

## Учет изменений в метаданных

### Добавление новых объектов

### Изменение существующих объектов

## Решение проблем

## Открытые вопросы

### Производительность

### Версионирование

Единственный механизм, который КОД сейчас предоставляет для обмена данными с разными версиями метаданных - это совместимость на уровне XDTO-пакета. Например, для новых реквизитов можно поставить "Минимальное количество = 0", и новые версии конфигурации примут сообщения старых версий. Переименование реквизитов также можно поддержать созданием нового реквизита со свойством "Минимальное количество = 0". Пакет также можно подменить в режиме Предприятия, загрузив в константу выгруженную XSD-схему (это несколько замедлит обмен, поскольку каждый сеанс КОД будет создавать фабрику XDTO из тяжелого макета).

Есть, однако, проблемы с более тяжелыми изменениями метаданных, например:
* Новые объекты метаданных. Что узел старой конфигурации должен делать с новыми объектами?
* Изменение структуры регистра сведений. Как быть с накопленными отметками? Что узел-получатель должен делать с наборами записей иной структуры?

Следует решить, в каком объеме КОД будет поддерживать версионирование: только ли на краткий период обновления всех узлов? Или режим с разными версиями ИБ узлов будет рабочим? Какого рода изменения метаданных мы будем поддерживать, а какие - нет?

### Режим восстановления

КОД первого поколения для конфигурации "Документооборот Почты России" включал в себя механизм восстановления узлов данными других узлов при потере. При разработке второго поколения механизм восстановления не тестировался и, скорее всего, сломан. Для типовой следует принять решение либо о вырезании механизма восстановления, либо о его восстановлении.
